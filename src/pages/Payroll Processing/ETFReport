// src/pages/Payroll Processing/ETFReport.jsx
import React, { useState, useEffect, useMemo } from "react";
import Layout from "../../components/Layout";
import PageHeader from "../../components/PageHeader";
import { useNavigate, useLocation } from "react-router-dom";
import { apiGet, apiGetWithParams } from "../../services/api";
import { formatCurrency } from "../../utils/helpers";

export default function ETFReport() {
  const navigate = useNavigate();
  const location = useLocation();

  // ================= TABS =================
  const tabs = [
    { label: "Salary Transfer Overview", path: "/payroll-processing" },
    { label: "Employee Salary Details", path: "/employee-salary-details" },
    { label: "EPF Transfer", path: "/epf-transfer" },
    { label: "ETF Transfer", path: "/etf-transfer" },
    { label: "Income Tax Transfer", path: "/income-tax-transfer" },
    { label: "Insurance Payments", path: "/insurance-payments" },
  ];

  // ================= STATE =================
  const [reportData, setReportData] = useState([]);
  const [loading, setLoading] = useState(false);
  const [generatingPdf, setGeneratingPdf] = useState(false);
  const [departments, setDepartments] = useState([]);
  const [availableMonths, setAvailableMonths] = useState([]);
  
  // Filters
  const today = new Date();
  const defaultMonth = `${today.getFullYear()}-${String(today.getMonth() + 1).padStart(2, '0')}`;
  
  const [filters, setFilters] = useState({
    month: defaultMonth,
    department: "all",
    search: "",
    status: "all"
  });

  // ================= FETCH DEPARTMENTS =================
  useEffect(() => {
    const fetchDepartments = async () => {
      try {
        const res = await apiGet('/salary/departments');
        setDepartments(Array.isArray(res?.data) ? res.data : []);
      } catch (err) {
        console.error('Failed to fetch departments:', err);
        setDepartments([]);
      }
    };

    fetchDepartments();
  }, []);

  // ================= FETCH AVAILABLE MONTHS =================
  useEffect(() => {
    const fetchAvailableMonths = async () => {
      try {
        // Using the payroll available months endpoint
        const res = await apiGet('/payroll/available-months');
        if (res.ok && res.data) {
          setAvailableMonths(Array.isArray(res.data) ? res.data : []);
        }
      } catch (err) {
        console.error('Failed to fetch available months:', err);
        // Generate default months if API fails
        const defaultMonths = generateDefaultMonths();
        setAvailableMonths(defaultMonths);
      }
    };

    fetchAvailableMonths();
  }, []);

  // Generate default months (current and previous 12 months)
  const generateDefaultMonths = () => {
    const months = [];
    const currentDate = new Date();
    
    for (let i = 0; i < 12; i++) {
      const date = new Date(currentDate.getFullYear(), currentDate.getMonth() - i, 1);
      const year = date.getFullYear();
      const month = date.getMonth() + 1;
      const monthName = date.toLocaleString('default', { month: 'long' });
      
      months.push({
        value: `${year}-${String(month).padStart(2, '0')}`,
        label: `${monthName} ${year}`,
        year,
        month
      });
    }
    
    return months;
  };

  // ================= FETCH ETF REPORT DATA =================
  const fetchETFReport = async () => {
    setLoading(true);
    try {
      const [year, month] = filters.month.split('-').map(Number);
      
      // Try to get data from ETF/EPF payment history endpoint
      const params = {
        year,
        month,
        ...(filters.department !== 'all' && { department_id: filters.department }),
        ...(filters.search && { search: filters.search }),
        ...(filters.status !== 'all' && { status: filters.status })
      };

      // First try: Get from ETF/EPF payment history
      let data = [];
      let totals = { 
        totalBasic: 0, 
        totalETF: 0 
      };
      
      try {
        const paymentRes = await apiGetWithParams('/salary/etf-epf/payment-history', { year, month });
        if (paymentRes.ok && paymentRes.data) {
          // Transform payment history data - ETF only
          const historyData = Array.isArray(paymentRes.data) ? paymentRes.data : [];
          data = historyData.map(item => ({
            id: item.id || item.employee_id,
            employee_id: item.employee_id,
            etf_number: item.etf_number || 'N/A',
            epf_number: item.epf_number || 'N/A',
            full_name: item.full_name,
            employee_code: item.employee_code,
            department_name: item.department_name || 'N/A',
            basic_salary: Number(item.basic_salary || item.gross_salary || 0),
            etf_amount: Number(item.employer_etf_contribution || 0),
            process_date: item.process_date,
            status: item.status || 'Processed'
          }));
          
          // Calculate totals
          totals = data.reduce((acc, item) => ({
            totalBasic: acc.totalBasic + item.basic_salary,
            totalETF: acc.totalETF + item.etf_amount
          }), totals);
        }
      } catch (historyError) {
        console.log('Payment history endpoint not available, trying process list');
        
        // Fallback: Get from ETF/EPF process list
        try {
          const processRes = await apiGetWithParams('/salary/etf-epf/process-list', { year, month });
          if (processRes.ok && processRes.data) {
            const processData = Array.isArray(processRes.data) ? processRes.data : [];
            data = processData.map(item => ({
              id: item.employee_id,
              employee_id: item.employee_id,
              etf_number: item.etf_number || 'N/A',
              epf_number: item.epf_number || 'N/A',
              full_name: item.full_name,
              employee_code: item.employee_code,
              department_name: item.department_name || 'N/A',
              basic_salary: Number(item.basic_salary || 0),
              etf_amount: Number(item.etf_employer_contribution || 0),
              process_date: item.processed_at || new Date().toISOString().slice(0, 10),
              status: 'Calculated'
            }));
            
            // Calculate totals
            totals = data.reduce((acc, item) => ({
              totalBasic: acc.totalBasic + item.basic_salary,
              totalETF: acc.totalETF + item.etf_amount
            }), totals);
          }
        } catch (processError) {
          console.log('Process list endpoint not available, using fallback calculation');
          
          // Final fallback: Get employee list and calculate ETF only
          try {
            const employeesRes = await apiGet('/salary/employees');
            const employeesData = Array.isArray(employeesRes?.data) ? employeesRes.data : [];
            
            // Filter by department if needed
            let filteredEmployees = employeesData;
            if (filters.department !== 'all') {
              filteredEmployees = employeesData.filter(emp => 
                String(emp.department_id) === filters.department || 
                emp.department_name?.toLowerCase() === filters.department?.toLowerCase()
              );
            }
            
            // Filter by search if needed
            if (filters.search) {
              filteredEmployees = filteredEmployees.filter(emp => 
                emp.full_name?.toLowerCase().includes(filters.search.toLowerCase()) ||
                emp.employee_code?.toLowerCase().includes(filters.search.toLowerCase())
              );
            }
            
            data = filteredEmployees.map(emp => {
              const basic = Number(emp.basic_salary || emp.salary || 0);
              const etfAmount = (basic * 3) / 100;
              
              return {
                id: emp.employee_id || emp.id,
                employee_id: emp.employee_id || emp.id,
                etf_number: emp.etf_no || emp.etf_number || 'N/A',
                epf_number: emp.epf_no || emp.epf_number || 'N/A',
                full_name: emp.full_name,
                employee_code: emp.employee_code || `EMP${emp.employee_id || emp.id}`,
                department_name: emp.department || emp.department_name || 'N/A',
                basic_salary: basic,
                etf_amount: etfAmount,
                process_date: new Date().toISOString().slice(0, 10),
                status: 'Estimated'
              };
            });
            
            // Calculate totals
            totals = data.reduce((acc, item) => ({
              totalBasic: acc.totalBasic + item.basic_salary,
              totalETF: acc.totalETF + item.etf_amount
            }), totals);
          } catch (finalError) {
            console.error('All ETF data sources failed:', finalError);
            data = [];
          }
        }
      }
      
      // Apply search filter if data is loaded
      if (filters.search && data.length > 0) {
        const searchLower = filters.search.toLowerCase();
        data = data.filter(item => 
          item.full_name?.toLowerCase().includes(searchLower) ||
          item.employee_code?.toLowerCase().includes(searchLower) ||
          item.etf_number?.toLowerCase().includes(searchLower) ||
          item.epf_number?.toLowerCase().includes(searchLower) ||
          item.department_name?.toLowerCase().includes(searchLower)
        );
      }
      
      // Apply status filter
      if (filters.status !== 'all' && data.length > 0) {
        data = data.filter(item => item.status === filters.status);
      }
      
      // Recalculate totals after filtering
      if (data.length > 0) {
        totals = data.reduce((acc, item) => ({
          totalBasic: acc.totalBasic + item.basic_salary,
          totalETF: acc.totalETF + item.etf_amount
        }), { 
          totalBasic: 0, 
          totalETF: 0
        });
      }
      
      setReportData({
        data,
        totals,
        period: `${month}/${year}`,
        generatedDate: new Date().toLocaleString(),
        recordCount: data.length
      });
      
    } catch (error) {
      console.error('Failed to fetch ETF report:', error);
      alert('Failed to load ETF report data. Please try again.');
      setReportData({
        data: [],
        totals: { 
          totalBasic: 0, 
          totalETF: 0 
        },
        period: filters.month,
        generatedDate: new Date().toLocaleString(),
        recordCount: 0
      });
    } finally {
      setLoading(false);
    }
  };

  // ================= INITIAL FETCH =================
  useEffect(() => {
    fetchETFReport();
  }, []);

  // ================= EXPORT FUNCTIONS =================
  const handleExportCSV = () => {
    if (!reportData.data || reportData.data.length === 0) {
      alert('No data to export');
      return;
    }

    const headers = ['ETF Number', 'EPF Number', 'Employee Code', 'Employee Name', 'Department', 'Basic Salary', 'ETF Amount (3%)', 'Status'];
    
    const csvRows = reportData.data.map(item => [
      item.etf_number,
      item.epf_number,
      item.employee_code,
      `"${item.full_name}"`,
      `"${item.department_name}"`,
      item.basic_salary.toFixed(2),
      item.etf_amount.toFixed(2),
      item.status
    ]);

    // Add totals row
    csvRows.push([
      '', '', '', 'TOTALS:', '',
      reportData.totals.totalBasic.toFixed(2),
      reportData.totals.totalETF.toFixed(2),
      ''
    ]);

    const csvContent = [headers, ...csvRows]
      .map(row => row.join(','))
      .join('\n');

    const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    const [year, month] = filters.month.split('-');
    a.href = url;
    a.download = `ETF_Report_${year}_${month}.csv`;
    a.click();
    URL.revokeObjectURL(url);
  };

  const handleExportPDF = async () => {
    setGeneratingPdf(true);
    try {
      const [year, month] = filters.month.split('-');
      
      // Generate PDF using the backend PDF generation endpoint
      // This would require a PDF generation endpoint in your backend
      window.open(
        `${process.env.VITE_API_URL || 'http://localhost:4000'}/api/payroll/export-etf-pdf?month=${month}&year=${year}`,
        '_blank'
      );
    } catch (error) {
      console.error('Failed to generate PDF:', error);
      alert('PDF generation feature is not available yet');
    } finally {
      setGeneratingPdf(false);
    }
  };

  const handleProcessETF = () => {
    const [year, month] = filters.month.split('-');
    const employeeIds = reportData.data.map(item => item.employee_id);
    
    if (employeeIds.length === 0) {
      alert('No employees to process');
      return;
    }
    
    if (window.confirm(`Process ETF contributions for ${employeeIds.length} employees for ${month}/${year}?`)) {
      // Navigate to ETF processing page
      navigate("/process-etf", {
        state: {
          month,
          year,
          employeeIds,
          reportData: reportData.data
        }
      });
    }
  };

  // ================= FILTERED DATA =================
  const filteredData = useMemo(() => {
    if (!reportData.data) return [];
    
    let data = reportData.data;
    
    // Apply department filter
    if (filters.department !== 'all') {
      data = data.filter(item => 
        item.department_name?.toLowerCase().includes(filters.department.toLowerCase()) ||
        String(item.department_id) === filters.department
      );
    }
    
    // Apply search filter
    if (filters.search) {
      const searchLower = filters.search.toLowerCase();
      data = data.filter(item => 
        item.full_name?.toLowerCase().includes(searchLower) ||
        item.employee_code?.toLowerCase().includes(searchLower) ||
        item.etf_number?.toLowerCase().includes(searchLower) ||
        item.epf_number?.toLowerCase().includes(searchLower)
      );
    }
    
    // Apply status filter
    if (filters.status !== 'all') {
      data = data.filter(item => item.status === filters.status);
    }
    
    return data;
  }, [reportData.data, filters]);

  // ================= RENDER =================
  return (
    <Layout>
      <PageHeader 
        breadcrumb={["Payroll Processing", "ETF Transfer", "ETF Report"]} 
        title="ETF Contribution Report" 
      />

      {/* ================= TABS ================= */}
      <div className="card" style={{ display: "flex", gap: "8px", marginBottom: "16px", flexWrap: "wrap" }}>
        {tabs.map((t) => (
          <button
            key={t.path}
            className={`btn ${location.pathname === t.path ? "btn-primary" : "btn-soft"}`}
            onClick={() => navigate(t.path)}
          >
            {t.label}
          </button>
        ))}
      </div>

      {/* ================= ACTIONS BAR ================= */}
      <div className="card" style={{ padding: "16px", marginBottom: "16px" }}>
        <div style={{ 
          display: "flex", 
          justifyContent: "space-between", 
          alignItems: "center",
          flexWrap: "wrap",
          gap: "12px" 
        }}>
          <button className="btn btn-soft" onClick={() => navigate("/etf-transfer")}>
            ‚Üê Back to ETF Transfer
          </button>
          
          <div style={{ display: "flex", gap: "8px", flexWrap: "wrap" }}>
            <button 
              className="btn btn-soft" 
              onClick={handleExportCSV}
              disabled={loading || !reportData.data || reportData.data.length === 0}
            >
              üìä Export CSV
            </button>
            <button 
              className="btn btn-soft" 
              onClick={handleExportPDF}
              disabled={loading || generatingPdf || !reportData.data || reportData.data.length === 0}
            >
              {generatingPdf ? 'Generating...' : 'üìÑ Download PDF'}
            </button>
            <button 
              className="btn btn-primary" 
              onClick={handleProcessETF}
              disabled={loading || !reportData.data || reportData.data.length === 0}
            >
              üí∞ Process ETF Payment
            </button>
          </div>
        </div>
      </div>

      {/* ================= FILTERS ================= */}
      <div className="card" style={{ padding: "24px", marginBottom: "24px" }}>
        <div className="grid-4" style={{ gap: "16px", alignItems: "end" }}>
          <div>
            <label style={{ display: "block", fontSize: 12, color: "var(--muted)", marginBottom: 6 }}>
              Select Month
            </label>
            <select
              className="select"
              value={filters.month}
              onChange={(e) => setFilters({...filters, month: e.target.value})}
              style={{ width: "100%" }}
            >
              {availableMonths.length > 0 ? (
                availableMonths.map(month => (
                  <option key={month.value} value={month.value}>
                    {month.label}
                  </option>
                ))
              ) : (
                <option value={defaultMonth}>
                  {new Date().toLocaleString('default', { month: 'long' })} {new Date().getFullYear()}
                </option>
              )}
            </select>
          </div>

          <div>
            <label style={{ display: "block", fontSize: 12, color: "var(--muted)", marginBottom: 6 }}>
              Department
            </label>
            <select
              className="select"
              value={filters.department}
              onChange={(e) => setFilters({...filters, department: e.target.value})}
              style={{ width: "100%" }}
            >
              <option value="all">All Departments</option>
              {departments.map(dept => (
                <option key={dept.id} value={dept.id}>
                  {dept.name}
                </option>
              ))}
            </select>
          </div>

          <div>
            <label style={{ display: "block", fontSize: 12, color: "var(--muted)", marginBottom: 6 }}>
              Search
            </label>
            <input
              type="text"
              className="input"
              placeholder="Search by name, code, ETF or EPF number"
              value={filters.search}
              onChange={(e) => setFilters({...filters, search: e.target.value})}
              style={{ width: "100%" }}
            />
          </div>

          <div>
            <label style={{ display: "block", fontSize: 12, color: "var(--muted)", marginBottom: 6 }}>
              Status
            </label>
            <select
              className="select"
              value={filters.status}
              onChange={(e) => setFilters({...filters, status: e.target.value})}
              style={{ width: "100%" }}
            >
              <option value="all">All Status</option>
              <option value="Processed">Processed</option>
              <option value="Calculated">Calculated</option>
              <option value="Estimated">Estimated</option>
              <option value="Pending">Pending</option>
            </select>
          </div>
        </div>

        <div style={{ display: "flex", justifyContent: "flex-end", gap: "8px", marginTop: "16px" }}>
          <button 
            className="btn btn-soft" 
            onClick={() => setFilters({
              month: defaultMonth,
              department: "all",
              search: "",
              status: "all"
            })}
          >
            Clear Filters
          </button>
          <button 
            className="btn btn-primary" 
            onClick={fetchETFReport}
            disabled={loading}
          >
            {loading ? 'Loading...' : 'üîç Generate Report'}
          </button>
        </div>
      </div>

      {/* ================= SUMMARY CARDS ================= */}
      {reportData.totals && (
        <div className="grid-3" style={{ marginBottom: "24px", gap: "12px" }}>
          <div className="card" style={{ padding: "16px", borderLeft: "4px solid #3b82f6" }}>
            <div style={{ fontSize: "12px", color: "var(--muted)" }}>Total Employees</div>
            <div style={{ fontSize: "20px", fontWeight: "700" }}>
              {filteredData.length}
            </div>
          </div>
          <div className="card" style={{ padding: "16px", borderLeft: "4px solid #10b981" }}>
            <div style={{ fontSize: "12px", color: "var(--muted)" }}>Total Basic Salary</div>
            <div style={{ fontSize: "20px", fontWeight: "700" }}>
              {formatCurrency(reportData.totals.totalBasic || 0)}
            </div>
          </div>
          <div className="card" style={{ padding: "16px", borderLeft: "4px solid #8b5cf6" }}>
            <div style={{ fontSize: "12px", color: "var(--muted)" }}>Total ETF (3%)</div>
            <div style={{ fontSize: "20px", fontWeight: "700" }}>
              {formatCurrency(reportData.totals.totalETF || 0)}
            </div>
          </div>
        </div>
      )}

      {/* ================= REPORT TABLE ================= */}
      <div className="card" style={{ overflowX: "auto" }}>
        <div style={{ 
          padding: "16px", 
          borderBottom: "1px solid var(--border)", 
          display: "flex", 
          justifyContent: "space-between", 
          alignItems: "center" 
        }}>
          <div>
            <h3 style={{ fontSize: "16px", fontWeight: "600", margin: 0 }}>
              ETF Contribution Report: {filters.month}
            </h3>
            <div style={{ fontSize: "12px", color: "var(--muted)", marginTop: "4px" }}>
              Generated on {reportData.generatedDate || new Date().toLocaleString()} ‚Ä¢ {filteredData.length} records
            </div>
          </div>
          
          <div style={{ display: "flex", gap: "8px", alignItems: "center" }}>
            <span style={{
              padding: "4px 8px",
              borderRadius: "12px",
              fontSize: "11px",
              fontWeight: "500",
              backgroundColor: "#D1FAE5",
              color: "#065F46"
            }}>
              {filteredData.length === 0 ? 'No Data' : 'Data Verified'}
            </span>
            <div style={{ fontSize: "12px", color: "var(--muted)" }}>
              ETF Rate: 3% of Basic Salary
            </div>
          </div>
        </div>

        {loading ? (
          <div style={{ padding: "60px", textAlign: "center", color: "var(--muted)" }}>
            <div className="spinner" style={{ marginBottom: "10px" }}></div>
            Loading ETF contribution report...
          </div>
        ) : filteredData.length === 0 ? (
          <div style={{ padding: "60px", textAlign: "center", color: "var(--muted)" }}>
            No ETF data found for the selected filters.
            <div style={{ marginTop: "12px" }}>
              <button className="btn btn-soft" onClick={fetchETFReport}>
                Retry Loading Data
              </button>
            </div>
          </div>
        ) : (
          <>
            <table className="table" style={{ minWidth: "1000px" }}>
              <thead>
                <tr>
                  <th>ETF No.</th>
                  <th>EPF No.</th>
                  <th>Employee Code</th>
                  <th>Employee Name</th>
                  <th>Department</th>
                  <th style={{ textAlign: "right" }}>Basic Salary</th>
                  <th style={{ textAlign: "right", color: "#8b5cf6" }}>ETF Amount (3%)</th>
                  <th>Status</th>
                </tr>
              </thead>
              <tbody>
                {filteredData.map((item) => (
                  <tr key={item.id}>
                    <td>
                      <span style={{ fontWeight: "500", fontFamily: "monospace" }}>
                        {item.etf_number}
                      </span>
                    </td>
                    <td>
                      <span style={{ fontFamily: "monospace" }}>
                        {item.epf_number}
                      </span>
                    </td>
                    <td>{item.employee_code}</td>
                    <td>{item.full_name}</td>
                    <td>{item.department_name}</td>
                    <td style={{ textAlign: "right", fontFamily: "monospace" }}>
                      {formatCurrency(item.basic_salary)}
                    </td>
                    <td style={{ textAlign: "right", fontFamily: "monospace", color: "#8b5cf6", fontWeight: "700" }}>
                      {formatCurrency(item.etf_amount)}
                    </td>
                    <td>
                      <span style={{
                        padding: "4px 8px",
                        borderRadius: "12px",
                        fontSize: "11px",
                        fontWeight: "500",
                        backgroundColor: item.status === 'Processed' ? '#D1FAE5' : 
                                       item.status === 'Calculated' ? '#FEF3C7' : 
                                       item.status === 'Estimated' ? '#DBEAFE' : '#F3F4F6',
                        color: item.status === 'Processed' ? '#065F46' : 
                               item.status === 'Calculated' ? '#92400E' : 
                               item.status === 'Estimated' ? '#1E40AF' : '#374151'
                      }}>
                        {item.status}
                      </span>
                    </td>
                  </tr>
                ))}
              </tbody>
              <tfoot>
                <tr style={{ background: "var(--bg-light)", fontWeight: "700", borderTop: "2px solid var(--border)" }}>
                  <td colSpan="5" style={{ padding: "16px" }}>
                    GRAND TOTALS ({filteredData.length} employees)
                  </td>
                  <td style={{ textAlign: "right", padding: "16px" }}>
                    {formatCurrency(reportData.totals.totalBasic)}
                  </td>
                  <td style={{ textAlign: "right", padding: "16px", fontSize: "1.1em", color: "#8b5cf6" }}>
                    {formatCurrency(reportData.totals.totalETF)}
                  </td>
                  <td style={{ padding: "16px" }}>
                    {/* Empty cell for status column */}
                  </td>
                </tr>
              </tfoot>
            </table>
          </>
        )}
      </div>

      {/* ================= FOOTER NOTES ================= */}
      <div style={{ 
        marginTop: "24px", 
        padding: "16px", 
        borderRadius: "8px", 
        background: "#f8f9fa", 
        borderLeft: "4px solid #0d6efd" 
      }}>
        <p style={{ margin: "0 0 8px 0", fontSize: "14px", color: "#444", fontWeight: "600" }}>
          üìã ETF Contribution Information:
        </p>
        <ul style={{ margin: "0", paddingLeft: "20px", fontSize: "13px", color: "#666" }}>
          <li>ETF (Employees' Trust Fund) is 3% of basic salary contributed by employer</li>
          <li>ETF is separate from EPF and paid entirely by the employer</li>
          <li>All employees earning above the minimum wage threshold are eligible for ETF</li>
          <li>ETF contributions must be submitted to the ETF department monthly</li>
          <li>Form II must be filed with ETF department by the 15th of following month</li>
          <li>ETF contributions are not withdrawable by employees during employment</li>
          <li>Maintain ETF records for minimum of 10 years for compliance purposes</li>
        </ul>
      </div>
    </Layout>
  );
}